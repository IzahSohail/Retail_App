@startuml
!define AWSPUML https://raw.githubusercontent.com/awslabs/aws-icons-for-plantuml/v14.0/LATEST/AWSPUML
skinparam componentStyle rectangle

title Deployment Diagram - Retail App Architecture

' Development Environment
node "Developer Machine (Local Dev)" as devMachine {
  component "Vite Dev Server\n(Port 8000)" as viteServer
  component "Node.js Backend\n(Port 3001)\nnpm run dev" as localBackend
}

' Docker Production/Staging Environment
node "Docker Host" as dockerHost {
  rectangle "retail-network" {
    component "Frontend Container\n(Port 8000)\nNginx" as frontendContainer
    component "Backend Container\n(Port 3001)\nNode.js + Express" as backendContainer
    component "PostgreSQL Container\n(Port 5433→5432)\npostgres:15-alpine" as postgresContainer
  }
}

' External Cloud Services
cloud "Auth0 Cloud" as auth0 {
  component "OIDC Provider" as auth0OIDC
  component "User Management" as auth0Users
}

cloud "Aiven Cloud" as aivenCloud {
  database "Managed PostgreSQL\n(Production DB)" as aivenDB
}

cloud "Supabase Cloud" as supabaseCloud {
  storage "Object Storage\n(Images, Documents)" as supabaseStorage
}

' Development Flow
viteServer -down-> localBackend : "HTTP /api/*\nProxy or CORS"
localBackend -down-> aivenDB : "Prisma Client\nTCP 5432"
localBackend -down-> auth0OIDC : "OIDC Auth\nHTTPS"
localBackend -down-> supabaseStorage : "Upload Images\nREST API"

' Docker/Production Flow
frontendContainer -down-> backendContainer : "HTTP /api/*\nReverse Proxy"
backendContainer -right-> postgresContainer : "Prisma Client\nTCP 5432\n(Local DB)"
backendContainer -down-> aivenDB : "Prisma Client\nTCP 5432\n(Cloud DB)"
backendContainer -down-> auth0OIDC : "OIDC Auth\nHTTPS"
backendContainer -down-> supabaseStorage : "Upload Files\nREST API"

note top of devMachine
  **Local Development Setup:**
  - Vite HMR for fast frontend development
  - Backend runs with nodemon for auto-reload
  - Can use local Docker PostgreSQL or Aiven cloud
  - Environment variables from .env file
  
  **Start Commands:**
  - Frontend: cd frontend && npm run dev
  - Backend: cd backend && npm run dev
end note

note top of dockerHost
  **Docker Compose Deployment:**
  - docker-compose.yml orchestrates 3 services
  - frontend: Build React/Vite → Nginx static hosting
  - backend: Node.js Express API server
  - postgres: Local PostgreSQL for dev/testing
  
  **Volumes:**
  - Backend source mounted for hot reload
  - Frontend build mounted as read-only
  - Postgres data persisted
  
  **Networks:**
  - All services on retail-network bridge
  
  **Start Command:**
  - docker-compose up -d
end note

note right of auth0
  **Auth0 Configuration:**
  - OpenID Connect (OIDC) flow
  - Social login providers
  - JWT token issuance
  - User profile management
  
  **Environment Variables:**
  - AUTH0_CLIENT_ID
  - AUTH0_CLIENT_SECRET
  - AUTH0_ISSUER_BASE_URL
  - AUTH0_BASE_URL
end note

note right of aivenCloud
  **Aiven PostgreSQL:**
  - Managed cloud database
  - Used for production/staging
  - Automatic backups
  - High availability
  
  **Connection:**
  - DATABASE_URL env variable
  - SSL enabled
  - Prisma migrations managed
end note

note right of supabaseCloud
  **Supabase Storage:**
  - Product images
  - Return/RMA photos
  - Business verification documents
  
  **Buckets:**
  - products (product images)
  - returns (RMA photos)
  
  **Environment Variables:**
  - SUPABASE_URL
  - SUPABASE_SERVICE_ROLE_KEY
end note

' Port Mappings
note bottom of frontendContainer
  Exposed Ports:
  - 8000:80 (HTTP)
end note

note bottom of backendContainer
  Exposed Ports:
  - 3001:3001 (HTTP)
  
  Depends On:
  - postgres (healthcheck)
end note

note bottom of postgresContainer
  Exposed Ports:
  - 5433:5432 (PostgreSQL)
  
  Health Check:
  - pg_isready command
end note

@enduml
